openapi: 3.0.3
info:
  title: Full Amend API for TTP Plans
  description: |
    An API called by CDCS when a customer who has a TTP set up originally via an operator or via the self serve journey wants to add or remove a debt and/or liability from their existing TTP. The TTP service will then inform the relevant HoDs (via different APIs) so the TTP can be amended.

    ```
    Change Log
    ```
      | Version | Date | Author | Description |
      |---|-----|------|-----|
      | 0.0.1| 06-05-2025 | Alex Olkhovskiy | Initial version based on requirements |
      | 0.0.2| 27-01-2026 | Robyn Garlington | Full Amend API: Split into originalPaymentPlan and newPaymentPlan with charge amendment to understand which HoD API to call and which plan data to provide. Make mini fullAmend schema for R2 tests |
  version: 0.0.2
servers:
  - url: https://api.service.hmrc.gov.uk/
tags:
  - name: individuals
    description: Full amend TTP plans and inform HoDs (CESA and ETMP)
paths:
  /individuals/time-to-pay-proxy/full-amend:
    post:
      tags:
        - individuals
      summary: Full amend TTP plan and inform HoDs
      operationId: FullAmendTTPPlanAndInformHoDs
      description: |
        An API called by CDCS to perform a full amendment of a TTP plan and inform HoDs (CESA + ETMP) of the changes.

        Response Behavior:
        - Returns HTTP 200 when all downstream HoDs are called and responses can be parsed successfully (regardless of individual HoD response status codes)
        - Returns HTTP 500 only for internal TTP errors or when responses from downstream APIs cannot be parsed
        - The response includes details of all HoDs called with their status codes to help operators determine any required manual steps
      parameters:
        - name: correlationId
          in: header
          description: Correlation Id used for end to end traceability
          required: true
          schema:
            type: string
            format: uuid
            example: f0bd1f32-de51-45cc-9b18-0520d6e3ab1a
      security:
        - applicationRestricted:
            - write:time-to-pay-proxy
      requestBody:
        description: Request body with fields to amend a TTP in CESA and ETMP.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FullAmendRequest'
            examples:
              opLedExample:
                summary: Sample request for Op-led TTP amendment
                value:
                  identifications:
                    - idType: UTR
                      idValue: '1234567890'
                  originalPaymentPlan:
                    arrangementAgreedDate: '2025-05-01'
                    ttpEndDate: '2025-11-01'
                    initialPaymentDate: '2025-05-05'
                    initialPaymentAmount: 150
                    frequency: monthly
                    ddiReference: DD123456789
                    debtItemCharges:
                      - debtItemChargeId: XW006559808862
                        chargeSource: CESA
                      - debtItemChargeId: XW006559808863
                        chargeSource: ETMP
                  newPaymentPlan:
                    arrangementAgreedDate: '2025-05-01'
                    ttpEndDate: '2025-12-01'
                    initialPaymentDate: '2025-05-05'
                    initialPaymentAmount: 200
                    frequency: monthly
                    ddiReference: DD123456789
                    debtItemCharges:
                      - debtItemChargeId: XW006559808862
                        chargeSource: CESA
                        chargeAmendment: remain
                      - debtItemChargeId: XW006559808863
                        chargeSource: ETMP
                        chargeAmendment: removed
                      - debtItemChargeId: XW006559808864
                        chargeSource: ETMP
                        chargeAmendment: new
                  instalments:
                    - dueDate: '2025-06-01'
                      amountDue: 300
                    - dueDate: '2025-07-01'
                      amountDue: 300
                  channelIdentifier: advisor
                  transitioned: true
              ssttpExample:
                summary: Sample request for SSTTP amendment
                value:
                  identifications:
                    - idType: UTR
                      idValue: '9876543210'
                  originalPaymentPlan:
                    arrangementAgreedDate: '2025-05-01'
                    ttpEndDate: '2025-11-01'
                    initialPaymentDate: '2025-05-05'
                    initialPaymentAmount: 200
                    frequency: weekly
                    ddiReference: DD987654321
                    debtItemCharges:
                      - debtItemChargeId: XW006559808870
                        chargeSource: ETMP
                  newPaymentPlan:
                    arrangementAgreedDate: '2025-05-01'
                    ttpEndDate: '2025-12-01'
                    initialPaymentDate: '2025-05-05'
                    initialPaymentAmount: 250
                    frequency: weekly
                    ddiReference: DD987654321
                    debtItemCharges:
                      - debtItemChargeId: XW006559808870
                        chargeSource: ETMP
                        chargeAmendment: remain
                      - debtItemChargeId: XW006559808871
                        chargeSource: ETMP
                        chargeAmendment: new
                  instalments:
                    - dueDate: '2025-06-01'
                      amountDue: 100
                    - dueDate: '2025-06-08'
                      amountDue: 100
                  channelIdentifier: selfService
                  transitioned: true
      responses:
        '200':
          description: |
            Full amend API operation successful with results of calls to CESA and ETMP. All downstream HoDs were called and responses were parsed successfully.
            Individual HoD APIs may have returned success or error status codes - this is reported in the apisCalled array.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullAmendResponse'
              examples:
                allHoDsSuccessful:
                  summary: All downstream HoDs respond successfully (HTTP 200)
                  value:
                    apisCalled:
                      - processingDateTime: '2025-05-01T14:30:00Z'
                        name: CESA
                        statusCode: 200
                      - processingDateTime: '2025-05-01T14:31:00Z'
                        name: ETMP
                        statusCode: 200
                    processingDateTime: '2025-05-01T14:32:00Z'
                allHoDsUnsuccessful:
                  summary: All downstream HoDs respond unsuccessfully but responses parsed (HTTP 200)
                  value:
                    apisCalled:
                      - processingDateTime: '2025-05-01T14:30:00Z'
                        name: CESA
                        statusCode: 500
                        errorResponse: Internal server error in CESA
                      - processingDateTime: '2025-05-01T14:31:00Z'
                        name: ETMP
                        statusCode: 400
                        errorResponse: Invalid amendment payload
                    processingDateTime: '2025-05-01T14:32:00Z'
                mixedHoDsResponse:
                  summary: Mixed success/failure from HoDs but all responses parsed (HTTP 200)
                  value:
                    apisCalled:
                      - processingDateTime: '2025-05-01T14:30:00Z'
                        name: CESA
                        statusCode: 200
                      - processingDateTime: '2025-05-01T14:31:00Z'
                        name: ETMP
                        statusCode: 500
                        errorResponse: Error processing full amend
                    processingDateTime: '2025-05-01T14:32:00Z'
        '400':
          description: |
            Bad request due to invalid or missing data in the request payload.
            This indicates client-side errors that prevent TTP from processing the full amend request.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                badRequestExample:
                  summary: Invalid request example
                  value:
                    statusCode: 400
                    errorMessage: 'Invalid request payload: missing identifications'
        '401':
          description: ''
          headers: {}
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                statusCode: 401
                errorMessage: A user with no active session will return 401 response
        '500':
          description: |
            Internal TTP error or failure to parse responses from downstream HoDs.
            This status is returned only when TTP cannot complete its processing or cannot parse HoD responses.
            When individual HoD APIs return errors but responses can be parsed, a 200 status is returned instead.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullAmendErrorResponse'
              examples:
                internalParsingError:
                  summary: Internal TTP error - cannot parse HoD responses (HTTP 500)
                  value:
                    internalErrors:
                      - message: Could not parse response from calling CESA
                    processingDateTime: '2025-10-15T10:31:00Z'
                mixedSuccessWithInternalError:
                  summary: Some HoDs successful, others unparseable (HTTP 500)
                  value:
                    apisCalled:
                      - processingDateTime: '2025-10-15T10:30:00Z'
                        name: CESA
                        statusCode: 200
                    internalErrors:
                      - message: Could not parse response from calling ETMP
                    processingDateTime: '2025-10-15T10:31:00Z'
        '503':
          description: The server is temporarily unavailable due to overload or maintenance.
          headers: {}
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                statusCode: 503
                errorMessage: The server is temporarily unavailable.
components:
  securitySchemes:
    userRestricted:
      type: oauth2
      description: |
        HMRC supports OAuth 2.0 for authenticating user restricted API requests using an OAuth 2.0 Bearer Token in the AUTHORIZATION header.
        See https://developer.service.hmrc.gov.uk/api-documentation/docs/authorisation/user-restricted-endpoints for details.
      flows:
        authorizationCode:
          authorizationUrl: https://api.service.hmrc.gov.uk/oauth/authorize
          tokenUrl: https://api.service.hmrc.gov.uk/oauth/token
          refreshUrl: https://api.service.hmrc.gov.uk/oauth/refresh
          scopes: {}
    applicationRestricted:
      type: oauth2
      description: |
        HMRC supports OAuth 2.0 for authenticating application restricted API requests using an OAuth 2.0 Bearer Token in the AUTHORIZATION header.
        See https://developer.service.hmrc.gov.uk/api-documentation/docs/authorisation/application-restricted-endpoints for details.
      flows:
        clientCredentials:
          tokenUrl: https://api.service.hmrc.gov.uk/oauth/token
          scopes:
            read:time-to-pay-proxy: read ttp data
  schemas:
    ErrorResponse:
      title: ErrorResponse
      required:
        - statusCode
        - errorMessage
      properties:
        statusCode:
          type: integer
          description: http status code
        errorMessage:
          type: string
          description: Reason for error request
    DebtItemChargeReference:
      type: object
      required:
        - debtItemChargeId
        - chargeSource
      properties:
        debtItemChargeId:
          type: string
          description: An ID which uniquely identifies a particular charge. Required for ETMP but not CESA. Needed to know which charge relates to the charge source to know which HoD to call.
          example: XW006559808862
        chargeSource:
          type: string
          description: Source system of the charge. So we know when to call CESA or ETMP.
          enum:
            - CESA
            - ETMP
          example: CESA
    FullAmendIdentification:
       type: object
       required:
         - idType
         - idValue
       properties:
         idType:
           type: string
           description: Identifier type (e.g., UTR for Self Assessment)
           pattern: ^[A-Za-z0-9]{1,6}$
           example: UTR
         idValue:
           type: string
           description: Identifier value
           pattern: ^[A-Za-z0-9]{1,25}$
           example: '1234567890'
    OriginalPaymentPlan:
      type: object
      required:
        - arrangementAgreedDate
        - ttpEndDate
        - frequency
        - debtItemCharges
      properties:
        arrangementAgreedDate:
          type: string
          format: date
          description: The date when the plan was created
          example: '2025-05-01'
        ttpEndDate:
          type: string
          format: date
          description: Date for the last payment/instalment
          example: '2025-11-01'
        initialPaymentDate:
          type: string
          format: date
          description: For Op-led this is initialPaymentDate, for SSTTP this is initialCollectionDueDate
          example: '2025-05-05'
        initialPaymentAmount:
          type: number
          multipleOf: 0.01
          description: For Op-led this is initialPaymentAmount, for SSTTP this is initialCollectionAmountDue
          example: 150
        frequency:
          type: string
          enum:
            - single
            - weekly
            - 2Weekly
            - 4Weekly
            - monthly
            - quarterly
            - 6Monthly
            - annually
          description: Payment frequency (Note - single, 4Weekly, and quarterly do not map to CESA values)
          example: monthly
        ddiReference:
          type: string
          description: Direct Debit reference (may be blank if not applicable, especially for SSTTP plans)
          example: DD123456789
        debtItemCharges:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/DebtItemChargeReference'
          description: Array of debt item charges in the original plan. Required to know which HoD to call.
    ChargeAmendment:
      type: string
      enum:
        - new
        - removed
        - remain
      description: Indicates if the charge is new (added), removed, or remains unchanged in the amended plan
      example: new
    FullAmendDebtItemCharge:
      type: object
      required:
        - debtItemChargeId
        - chargeSource
        - chargeAmendment
      properties:
        debtItemChargeId:
          type: string
          description: An ID which uniquely identifies a particular charge. Required so we can tell ETMP charge references and need to know which HoD to call.
          example: XW006559808862
        chargeSource:
          type: string
          description: Source system of the charge. So we know whether to call CESA or ETMP or both.
          enum:
            - CESA
            - ETMP
          example: CESA
        chargeAmendment:
          $ref: '#/components/schemas/ChargeAmendment'
    NewPaymentPlan:
      type: object
      required:
        - arrangementAgreedDate
        - ttpEndDate
        - frequency
        - debtItemCharges
      properties:
        arrangementAgreedDate:
          type: string
          format: date
          description: The date when the plan was created
          example: '2025-05-01'
        ttpEndDate:
          type: string
          format: date
          description: Date for the last payment/instalment
          example: '2025-11-01'
        initialPaymentDate:
          type: string
          format: date
          description: For Op-led this is initialPaymentDate, for SSTTP this is initialCollectionDueDate
          example: '2025-05-05'
        initialPaymentAmount:
          type: number
          multipleOf: 0.01
          description: For Op-led this is initialPaymentAmount, for SSTTP this is initialCollectionAmountDue
          example: 150
        frequency:
          type: string
          enum:
            - single
            - weekly
            - 2Weekly
            - 4Weekly
            - monthly
            - quarterly
            - 6Monthly
            - annually
          description: Payment frequency (Note - single, 4Weekly, and quarterly do not map to CESA values)
          example: monthly
        ddiReference:
          type: string
          description: Direct Debit reference (may be blank if not applicable, especially for SSTTP plans)
          example: DD123456789
        debtItemCharges:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FullAmendDebtItemCharge'
          description: Array of debt item charges in the new plan with amendment status. Required to know which HoD to call and what action to take.
    FullAmendInstalment:
      type: object
      required:
        - dueDate
        - amountDue
      properties:
        dueDate:
          type: string
          format: date
          description: Due date for each regular instalment
          example: '2025-06-01'
        amountDue:
          type: number
          multipleOf: 0.01
          description: Amount due for the instalment
          example: 300
    FullAmendRequest:
      type: object
      required:
        - identifications
        - originalPaymentPlan
        - newPaymentPlan
        - instalments
        - channelIdentifier
        - transitioned
      properties:
        identifications:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FullAmendIdentification'
          description: Array of identifiers for the customer
        originalPaymentPlan:
          $ref: '#/components/schemas/OriginalPaymentPlan'
        newPaymentPlan:
          $ref: '#/components/schemas/NewPaymentPlan'
        instalments:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FullAmendInstalment'
          description: Array of payment instalments
        channelIdentifier:
          type: string
          enum:
            - advisor
            - selfService
          description: Channel through which arrangement was made (e.g. advisor, selfService)
          example: advisor
        transitioned:
          type: boolean
          description: Indicates whether the customer only has FDLs.
          example: true
    FullAmendAPIStatus:
      type: object
      required:
        - processingDateTime
        - name
        - statusCode
      properties:
        processingDateTime:
          type: string
          format: date-time
          description: Timestamp of processing the request in downstream API
          example: '2025-05-01T14:30:00Z'
        name:
          type: string
          description: The API name (CESA or ETMP)
          example: ETMP
        statusCode:
          type: integer
          description: HTTP status code from the downstream API
          example: 400
        errorResponse:
          type: string
          description: |
            Error message returned by the downstream API when the call failed.
            This field is present when the downstream API returns an error status code but TTP can parse the response.
          example: Invalid amendment request provided for full-amend
    FullAmendResponse:
      type: object
      required:
        - apisCalled
        - processingDateTime
      properties:
        apisCalled:
          type: array
          items:
            $ref: '#/components/schemas/FullAmendAPIStatus'
          description: Status of calls to each HoD API (done this way to future proof)
        processingDateTime:
          type: string
          format: date-time
          description: Timestamp for processing the full amend request (this is our one)
          example: '2025-05-01T14:35:00Z'
    FullAmendErrorResponse:
      type: object
      required:
        - processingDateTime
        - internalErrors
      properties:
        apisCalled:
          type: array
          items:
            $ref: '#/components/schemas/FullAmendAPIStatus'
          description: Status of calls to each HoD API (present when HoD APIs were called successfully)
        internalErrors:
          type: array
          items:
            type: object
            required:
              - message
            properties:
              message:
                type: string
                description: Error message describing the internal failure
                example: Could not parse response from calling CESA
          description: Internal errors that occurred during processing (present when TTP cannot parse HoD responses)
        processingDateTime:
          type: string
          format: date-time
          description: Timestamp for processing the full-amend request
          example: '2025-10-15T10:31:00Z'
